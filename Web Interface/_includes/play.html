<!-- <!DOCTYPE html> -->

<html>
	<head>
		<title>Mastermind</title>
		<meta charset="utf-8">
		<script>

		var boolDic = {
				true: 1,
				false: 0
				},
				pieceDic = {
				1: ".",
				2: ":",
				3: ":.",
				4: "::",
				".": 1,
				":": 2,
				":.": 3,
				"::": 4
				},
				levelAddress = window.location.href,
				level = levelAddress.charAt(levelAddress.length-2),
				colorOptions = Array("yellow", "blue", "red", "green", "orange", "purple"),
				color1 = colorOptions[Math.floor(Math.random()*colorOptions.length)],
				color2 = colorOptions[Math.floor(Math.random()*colorOptions.length)],
				color3 = colorOptions[Math.floor(Math.random()*colorOptions.length)],
				color4 = colorOptions[Math.floor(Math.random()*colorOptions.length)],
				colorCode = Array(color1, color2, color3, color4),
				maxTurns = {
					1: 12,
					2: 10,
					3: 8
				};

		console.log(colorCode);

		</script>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<style>

		@media (max-width:602px){
        #color_buttons {
            margin-left:22.5%;
        }
    }

    @media (min-width:602px){
      #color_buttons {
        margin-left:13.5%;
      }
    }

		.center {
			text-align: center;
			display: flex;
			align-items: center;
			justify-content: center;
			/* width: 50px; */
		}

		.btn-group button {
		  background-color: #4CAF50; /* Green background */
		  border: 1px solid green; /* Green border */
		  color: white; /* White text */
		  padding: 10px 24px; /* Some padding */
		  cursor: pointer; /* Pointer/hand icon */
		  float: center; /* Float the buttons side by side */
		}

		.btn-group button:not(:last-child) {
		  border-right: none; /* Prevent double borders */
		}
		/* Clear floats (clearfix hack) */
		.btn-group:after {
		  content: "";
		  clear: both;
		  display: table;
		}
		/* Add a background color on hover */
		.btn-group button:hover {
		  background-color: #3e8e41;
		}

		#hidden-button-win {
			display: none;
		}

		#hidden-button-lose {
			display: none;
		}

		.blinking{
		    animation:blinkingText 1s infinite;
		}

		@keyframes blinkingText{
		    0%{     color: #000;    }
		    49%{     color: #000;    }
		    50%{    color: transparent; }
		    99%{    color: transparent;  }
		    100%{   color: #000;    }
		}

		</style>
	</head>
	<body>
		<div id="level_message" align="center"></div>
		<script>

		document.getElementById("level_message").innerHTML = String(maxTurns[level])
		+ " tries to crack the four color code."

		</script>
		<!-- Load d3.js -->
		<script src="https://d3js.org/d3.v4.js"></script>
		<!-- Load color palettes -->
		<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
		<!-- Create a div where the graph will take place -->
		<div id="game_board" align="center"></div>
		<div id="end_game" align="center"></div>
		<div id="hidden-button-win">
			<div id="hidden-button-win-text">
				<span class="blinking"><p align="center" style="margin-left:-3.5px; margin-top:-25px; margin-bottom:5px;"><font size="5.5"><b>You win!</b></font></p></span>
			</div>
			<div class="center">
				<div class="btn-group">
					<a href="../play_mastermind/"><button class="button">Play Again</button></a>
					<br>
					<br>
					<br>
				</div>
			</div>
		</div>
		<div id="hidden-button-lose">
			<div id="hidden-button-lose-text">
				<span class="blinking"><p align="center" style="margin-left:-190px; margin-top:-220px;"><font size="5.5"><b>You lose!</b></font></p></span>
				<p align="center" style="margin-left:-158px; margin-top:-30px; margin-bottom:70px;">Here's the code:</p>
			</div>
			<div class="center">
				<div class="btn-group">
					<a href="../play_mastermind/"><button class="button">Play Again</button></a>
					<br>
					<br>
					<br>
				</div>
			</div>
		</div>
		<!-- Create a div where the color selection will take place -->
		<div id="color_buttons" align="center" style="margin-top:-60px; margin-bottom:-100px;"></div>
		<script>

		var	height_dic = {
			1: 500,
			2: 427,
			3: 354
		};
		// set the dimensions and margins of the graph
		var margin = {top: 30, right: 25, bottom: 30, left: 25},
			  width = 350 - margin.left - margin.right,
			  height = height_dic[level] - margin.top - margin.bottom;
		// append the svg object to the body of the page
		var svg1 = d3.select("#game_board")
				.append("svg")
				  .attr("width", width + margin.left + margin.right)
				  .attr("height", height + margin.top + margin.bottom)
				.append("g")
				  .attr("transform",
				        "translate(" + margin.left + "," + margin.top + ")");

		var colorDic = {
					"rgb(152, 78, 163)": "purple",
					"rgb(77, 175, 74)": "green",
					"rgb(55, 126, 184)": "blue",
					"rgb(228, 26, 28)": "red",
					"rgb(255, 255, 51)": "yellow",
					"rgb(255, 127, 0)": "orange",
					"purple": "rgb(152, 78, 163)",
					"green": "rgb(77, 175, 74)",
					"blue": "rgb(55, 126, 184)",
					"red": "rgb(228, 26, 28)",
					"yellow": "rgb(255, 255, 51)",
					"orange": "rgb(255, 127, 0)"
				},
				clickCount = 0,
				maxClicks = {
					1: 48,
					2: 40,
					3: 32
				},
				clickScoreDic = {
				},
				gridScoreDic = {
				},
				guessDic = {
				},
				bScores = Array(),
				xArray = Array(1, 2, 3, 4),
				yArray = Array(1, 1, 1, 1),
				gridA = 1,
				gridB = 2,
				gridC = 3,
				gridD = 4,
				fillDic = {
					W: "rgb(211,211,211)",
					B: "rgb(211,211,211)"
				},
				i;

		for ( i = 1; i < maxClicks[level]+1; i++ ) {
		  fillDic[i] = 100
		};
		for ( i = 1; i < maxTurns[level]+1; i++ ) {
		  clickScoreDic[i] = Array(gridA, gridB, gridC, gridD),
			gridA += 4,
			gridB += 4,
			gridC += 4,
			gridD += 4
		};
		//Read the data
		var createBoard = function(fillDic, guessDic, clickCount) {
			d3.csv("../assets/game_board" + String(level) + ".csv", function(data) {
			  // Labels of row and columns -> unique identifier of the column called 'group' and 'variable'
			  var turnSlots = d3.map(data, function(d){ return d.group; }).keys(),
						numTurns = d3.map(data, function(d){ return d.variable; }).keys();
			  // Build X and Y scales and axis:
			  var x = d3.scaleBand()
							    .range([ 0, width ])
							    .domain(turnSlots)
							    .padding(0.05),
						y = d3.scaleBand()
							    .range([0, height ])
							    .domain(numTurns)
							    .padding(0.05);

				svg1.append("g")
				    .style("font-size", 15)
				    .call(d3.axisTop(x).tickSize(0))
							.select(".domain").remove()

				svg1.append("g")
				    .style("font-size", 15)
						.call(d3.axisLeft(y).tickSize(0))
				    	.select(".domain").remove()
			  // Build color scale
			  var myColor = d3.scaleSequential()
										    .interpolator(d3.interpolateCubehelixDefault)
										    .domain([1,100])

				var tooltip1 = d3.select("#game_board")
												 .append("div")
													 .style("opacity", 0)
													 .attr("class", "tooltip")
													 .style("background-color", "white")
													 .style("border", "solid")
													 .style("border-width", "2px")
													 .style("border-radius", "5px")
													 .style("padding", "5px")
				// Three function that change the tooltip when user hover / move / leave a cell
				var mouseover1 = function(d) {
					if (d.group == "W" || d.group =="B")
					{ tooltip1
						 .style("opacity", 1)
					 d3.select(this)
						 .style("stroke-width", 4)
						 .style("stroke", "black")
						 .style("opacity", 1) }
					 }

				var mousemove1 = function(d) {
					if ( d.group=="W" || d.group=="B" ) {
						if ( gridScoreDic[d.score_index]==null )
							{ toolNumber = 0 }
						else
							{ toolNumber = pieceDic[gridScoreDic[d.score_index]] }
						if ( d.group=="W" )
							{ colorState = " wrong" }
						if ( d.group=="B" )
							{ colorState = " right" }
						if ( toolNumber==1)
							{ cPlur = "" }
						else
							{ cPlur = "s" }
						if ( toolNumber!=0 ) {
							tooltip1
								.html(toolNumber + " right color" + cPlur + " in"
								+ "<br>the " + colorState + " place.")
								.style("left", (d3.mouse(this)[0]+70) + "px")
								.style("top", (d3.mouse(this)[1]) + "px")
							}
						else if ( toolNumber==0 && (d.variable)<=(clickCount/4) ) {
							tooltip1
								.html("No right color" + cPlur + " in"
								+ "<br>the " + colorState + " place.")
								.style("left", (d3.mouse(this)[0]+70) + "px")
								.style("top", (d3.mouse(this)[1]) + "px")
							}
						else
							{ tooltip1
									.html("This round hasn't<br>been played yet.")
									.style("left", (d3.mouse(this)[0]+70) + "px")
									.style("top", (d3.mouse(this)[1]) + "px") }
					}}

				var mouseleave1 = function(d) {
					if ( d.group=="W" || d.group=="B" ) {
						tooltip1
							.style("opacity", 0)
						d3.select(this)
							.style("stroke-width", 1)
							.style("stroke", "black")
							.style("opacity", 1)
				}}
			  // add the squares
			  var rect = svg1.selectAll()
				    .data(data, function(d) { return d.group+':'+d.variable; })
				    .enter();

				rect.append("rect")
				      .attr("x", function(d) { return x(d.group) })
				      .attr("y", function(d) { return y(d.variable) })
				      .attr("rx", 4)
				      .attr("ry", 4)
				      .attr("width", x.bandwidth() )
				      .attr("height", y.bandwidth() )
				      .style("fill", function(d) { if ( clickCount==0 && d.group!="W" && d.group!="B" )
																						{ return myColor(100) }
																					 else if ( fillDic[d.color_index]==100 && d.group!="W" && d.group!="B" )
																						{ return myColor(100) }
																					 else
																					 	{ return fillDic[d.color_index] }
																					})
							.style("stroke-width", function(d) { if ( d.color_index==clickCount+1 )
																										{ return 4 }
																									 else
																									 	{ return 1 }
																									})
							.style("stroke", "black")
				      .style("opacity", 1)
					    .on("mouseover", mouseover1)
					    .on("mousemove", mousemove1)
					    .on("mouseleave", mouseleave1);

			rect.append("text")
						.attr("x", function(d) { return x(d.group) + 17.5 })
						.attr("y", function(d) { return y(d.variable) + 23.5 })
						.attr("rx", 4)
						.attr("ry", 4)
						.attr("width", x.bandwidth() )
						.attr("height", y.bandwidth() )
			    .text(function(d) { if ( d.group=="W" && clickCount%4==0 && clickCount!=0 )
															{ var colorCodeCopy = Array(color1, color2, color3, color4);
																		dCount = 0,
																		wCount = 0,
																		guessColors = Array(
																			guessDic[(d.variable*4)-3],
																			guessDic[(d.variable*4)-2],
																			guessDic[(d.variable*4)-1],
																			guessDic[d.variable*4]);
																for ( i = 0; i < 4; i++ ) {
																	if ( guessColors[i-dCount]==colorCode[i] )
																		{ delete guessColors[i-dCount];
																			delete colorCodeCopy[i-dCount];
																			guessColors = guessColors.filter(Boolean);
																			colorCodeCopy = colorCodeCopy.filter(Boolean);
																			dCount+=1; }
																}
																while ( guessColors.length > 0 ) {
																	if ( colorCodeCopy.includes(guessColors[0]) )
																	{ wCount+=1,
																	  dIndex = colorCodeCopy.indexOf(guessColors[0]);
																		delete guessColors[0];
																		delete colorCodeCopy[dIndex];
																		guessColors = guessColors.filter(Boolean);
																		colorCodeCopy = colorCodeCopy.filter(Boolean); }
																	else
																		{ delete guessColors[0];
																		  guessColors = guessColors.filter(Boolean); }
																gridScoreDic[d.score_index] = pieceDic[wCount]};
																return gridScoreDic[d.score_index]
														}
														else if ( d.group=="B" && clickCount%4==0 && clickCount!=0 )
														{ gridScoreDic[d.score_index] = pieceDic[
															boolDic[guessDic[(d.variable*4)-3]==colorCode[0]] +
															boolDic[guessDic[(d.variable*4)-2]==colorCode[1]] +
															boolDic[guessDic[(d.variable*4)-1]==colorCode[2]] +
															boolDic[guessDic[(d.variable*4)]==colorCode[3]]];
															if ( String(gridScoreDic[d.score_index]) != "undefined") {
																bScores[d.variable] = gridScoreDic[d.score_index]
															}
														 return gridScoreDic[d.score_index] }
														 else if (( d.group=="W" || d.group=="B" ) &&
														 clickCount%4!=0 && clickCount!=0 ) {
															 return gridScoreDic[d.score_index] }
														 else
															{ return null }
														 })
						.style("font-size", 25)
						.style("stroke-width", 1.5)
						.style("stroke", "black")

			var endGameExecute = function(clickCount, gridScoreDic, bScores) {

				if ( bScores!=[] && bScores[bScores.length-1]=="::" ) {

					document.getElementById("hidden-button-win").style.display = "block";
					document.getElementById("color_buttons").style.display = "none";
				}

					else if ( bScores!=[] && bScores[bScores.length-1]!="::" && clickCount==maxClicks[level] ) {

						d3.csv("../assets/end_game.csv", function(data) {
								// set the dimensions and margins of the graph
								var margin = {top: 23.5, right: 123, bottom: 150, left: 25},
									  width = 350 - margin.left - margin.right,
									  height = 200;
							  // Labels of row and columns -> unique identifier of the column called 'group' and 'variable'
							  var turnSlots = d3.map(data, function(d){ return d.group; }).keys(),
										numTurns = d3.map(data, function(d){ return d.variable; }).keys();
							  // Build X and Y scales and axis:
							  var x = d3.scaleBand()
											    .range([ 0, width ])
											    .domain(turnSlots)
											    .padding(0.05),
										y = d3.scaleBand()
											    .range([0, height-160 ])
											    .domain(numTurns)
											    .padding(0.05);

							var svg3 = d3.select("#end_game")
								.append("svg")
								  .attr("width", width + margin.left + margin.right)
								  .attr("height",  height)
								.append("g")
								  .attr("transform",
								        "translate(" + margin.left + "," + margin.top + ")");

							var endGame = svg3.selectAll()
							    .data(data, function(d) { return d.group+':'+d.variable; })
							    .enter();

							endGame.append("rect")
										.attr("x", function(d) { return x(d.group) })
										.attr("y", function(d) { return y(d.variable) + 33 })
							      .attr("rx", 4)
							      .attr("ry", 4)
							      .attr("width", x.bandwidth() )
							      .attr("height", y.bandwidth() )
							      .style("fill", function(d) {
											colorFill = colorDic[colorCode[0]];
											delete colorCode[0];
											colorCode = colorCode.filter(Boolean);
											return colorFill
										})
										.style("stroke-width", 1)
										.style("stroke", "black")
							      .style("opacity", 1);
								})

					document.getElementById("hidden-button-lose").style.display = "block";
					document.getElementById("color_buttons").style.display = "none";

		}}

		endGameExecute(clickCount, gridScoreDic, bScores);

		});};

		createBoard(fillDic, guessDic, clickCount);

		var data = [1, 2, 3, 4, 5, 6],
				categorical = [{ "name" : "schemeSet1", "n": 6 }],
				colorScale = d3.scaleOrdinal(d3[categorical[0].name]);
		// create a tooltip
		var tooltip2 = d3.select("#color_buttons")
			.append("div")
				.style("opacity", 0)
				.attr("class", "tooltip");
		// Three function that change the tooltip when user hover / move / leave a cell
		var mouseover2 = function(d) {
			d3.select(this)
				.style("stroke-width", 5)
				.style("stroke", "black")
				.style("opacity", 1)
				.style("cursor", "pointer");
		};

		var mousemove2 = function(d) {
			tooltip2
				.style("left", (d3.mouse(this)[0]+70) + "px")
				.style("top", (d3.mouse(this)[1]) + "px")
		};

		var mouseleave2 = function(d) {
			tooltip2
				.style("opacity", 0)
			d3.select(this)
				.style("stroke-width", 2)
				.style("stroke", "black")
				.style("opacity", 1)
		};

	 var r = 100,
	     w = r * 3,
	     h = w,
	     rad = Math.PI/180,
	     interval = 360/data.length;

		var svg2 = d3.select('#color_buttons')
		    .append('svg')
			    .attr('width', w)
			    .attr('height', h)
		    .append('g')
		    	.attr('transform', 'translate(' + r + ',' + r + ')');

		var colorButtonsText = svg2.selectAll()
				.data(data, function(d) { return d.group+':'+d.variable; })
				.enter();

		colorButtonsText.append("text")
			 .attr("x", -21.5)
			 .attr("y", -5)
			 .attr("rx", 4)
			 .attr("ry", 4)
			 .attr("width", w )
			 .attr("height", h )
			 .text( "Choose" )
				 .style("font-family", "cursive")
				 .style("font-size", "17px")
				 .style("fill", "black");

		colorButtonsText.append("text")
			 .attr("x", -23)
			 .attr("y", 16.5)
			 .attr("rx", 4)
			 .attr("ry", 4)
			 .attr("width", w )
			 .attr("height", h )
			 .text( "a Color" )
				 .style("font-family", "cursive")
				 .style("font-size", "17px")
				 .style("fill", "black");

		svg2.selectAll("circle")
		    .data(data)
		    .enter()
				.append("circle")
					.style("stroke-width", 2)
					.style("stroke", "black")
					.style("opacity", 1)
			    .attr('fill', function(d, i ) { return colorScale(d); })
			    .attr('r', (w*3)/interval)
			    .attr('transform', function (d, i) {
			        return "translate(" + ((w/2-r) * Math.cos((interval*i)
							* Math.PI/180)) + "," + ((w/2-r) * Math.sin((interval*i)
							* Math.PI/180)) + ")"})
		    .on("mouseover", mouseover2)
		    .on("mousemove", mousemove2)
		    .on("mouseleave", mouseleave2)
				.on("click", function() {
	          clickCount += 1,
						fillDic[clickCount] = d3.select(this).style("fill"),
						guessDic[clickCount] = colorDic[d3.select(this).style("fill")],
						createBoard(fillDic, guessDic, clickCount)});

		</script>
	</body>
</html>
